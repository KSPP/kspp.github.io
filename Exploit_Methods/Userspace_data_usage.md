# Details

Sometimes an attacker won't be able to control the instruction pointer
directly, but they will be able to redirect the dereference a structure
or other pointer. In these cases, it is easiest to aim at malicious
structures that have been built in userspace to perform the
exploitation.

Note that under some emulation situations, this can be a superset that
includes [Userspace
execution](Exploit_Methods/Userspace_execution). (If we can
protect against userspace access, we'll also be protecting against
userspace execution.) Hardware protections tend to be separate, though,
due to different memory paths for instruction fetch (execution) and data
access (read/write).

# Examples

  - [cred
    structure](https://github.com/geekben/towelroot/blob/master/towelroot.c)
  - [fake kernel
    stack](http://labs.bromium.com/2015/02/02/exploiting-badiret-vulnerability-cve-2014-9322-linux-kernel-privilege-escalation/)
  - [Bad
    casts](http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=176155dac13f528e0a58c14dc322623219365d91)

# Mitigations

  - hardware segregation: SMAP (x86), PAN (arm, arm64), Domains (arm)
  - emulated PAN (memory segregation via segments, Domains, page table
    swapping, PCID, etc. e.g. PAX_MEMORY_UDEREF)

Right now, the upstream options available for Privileged Access Never
(PAN) are:

| CPU                                | Feature Name                                                                                                                      |
| ---------------------------------- | --------------------------------------------------------------------------------------------------------------------------------- |
| ARM                                | v7 (32-bit)                                                                                                                       |
| v8.0 (64-bit)                      | CONFIG_ARM64_SW_TTBR0_PAN (likely Linux v4.9 [Catalin's series](http://www.openwall.com/lists/kernel-hardening/2016/09/13/3)) |
| v8.1 (defined since December 2014) | hardware PAN (none shipping)                                                                                                      |
| x86                                | pre-late-Broadwell                                                                                                                |
| Broadwell+ (since October 2014)    | hardware PAN (SMAP)                                                                                                               |
| s/390                              | hardware PAN (Address Spaces)                                                                                                     |
| powerpc                            | radix MMU (since POWER9)                                                                                                          |
| PPC64 hash MMU (since POWER7)      | nothing yet, but implementation possible                                                                                          |
| PPC32 hash MMU                     | hardware PAN (KUAP)                                                                                                               |
| MPC 8xx                            | hardware PAN (KUAP)                                                                                                               |
| MIPS                               | nothing (could use ASID switching?)                                                                                               |